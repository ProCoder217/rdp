name: Windows 10 RDP via Bore (topuser only)

on:
  workflow_dispatch:
    inputs:
      rdp_hours:
        description: "Number of hours to enable RDP session (1‚Äì6)"
        required: true
        default: "6"

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 365

    steps:
    - name: Validate input and compute duration
      id: config
      run: |
        $hours = [int]("${{ github.event.inputs.rdp_hours }}")
        if ($hours -lt 1 -or $hours -gt 6) {
          Write-Error "Invalid input: hours must be between 1 and 6."
          exit 1
        }
        $seconds = $hours * 3600
        echo "rdp_seconds=$seconds" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Download rustup-init.exe
      run: Invoke-WebRequest -Uri https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe -OutFile rustup-init.exe

    - name: Install Rust
      run: .\rustup-init.exe -y

    - name: Add Cargo to PATH
      run: echo "$env:USERPROFILE\.cargo\bin" | Out-File -Append $env:GITHUB_PATH

    - name: Install bore-cli
      run: cargo install bore-cli

    - name: Create topuser and set original password
      run: net user topuser "T0pUser#25" /add

    - name: ‚úÖ Add topuser to RDP group only
      run: net localgroup "Remote Desktop Users" topuser /add

    - name: üîê Set runneradmin password to Ab@1234
      run: net user runneradmin Ab@1234

    - name: Enable Terminal Server (RDP)
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0

    - name: Enable RDP Firewall Rule
      run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Enable User Authentication for RDP
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1

    - name: Start bore tunnel and keep session alive
      run: |
        $borePath = "$env:USERPROFILE\.cargo\bin\bore.exe"
        Start-Process -NoNewWindow -FilePath $borePath -ArgumentList "local 3389 --to bore.pub"
        Write-Output "‚úÖ RDP tunnel started!"
        Write-Output "üñ•Ô∏è topuser login: T0pUser#25"
        Write-Output "üñ•Ô∏è runneradmin login: Ab@1244"
        Start-Sleep -Seconds $env:rdp_seconds
        
