name: Windows 10 RDP via Bore (topuser only)

on:
  
  workflow_dispatch:
    inputs:
      rdp_hours:
        description: "Number of hours to enable RDP session (1-6)"
        required: true
        default: "6"

jobs:
  build:
    runs-on: windows-2025
    timeout-minutes: 365 # max out, script will self-limit runtime

    steps:
    - name: Set rdp_hours (1-6) and duration in seconds
      id: set_hours
      run: |
        $input = "${{ github.event.inputs.rdp_hours }}"
        $hours = [int]$input
        if ($hours -lt 1 -or $hours -gt 6) {
          Write-Error "Invalid hours: $hours. Please enter a value between 1 and 6."
          exit 1
        }
        echo "hours=$hours" | Out-File -FilePath $env:GITHUB_ENV -Append
        echo "rdp_seconds=$($hours * 3600)" | Out-File -FilePath $env:GITHUB_ENV -Append

    - name: Download rustup-init.exe
      run: Invoke-WebRequest -Uri https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe -OutFile rustup-init.exe

    - name: Install Rust
      run: .\rustup-init.exe -y

    - name: Add Cargo to PATH
      run: echo "$env:USERPROFILE\.cargo\bin" | Out-File -Append $env:GITHUB_PATH

    - name: Install bore-cli
      run: cargo install bore-cli

    - name: Create only topuser for RDP and set password
      run: |
        net user topuser "T0pUser#25" /add
        net localgroup "Remote Desktop Users" topuser /add
        # To disable RDP for runneradmin:
        #net localgroup "Remote Desktop Users" runneradmin /delete || exit 0

    - name: Enable Terminal Server
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0

    - name: Enable RDP Firewall Rule
      run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

    - name: Set User Authentication
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

    - name: Create bore tunnel for RDP
      run: |
        $borePath = "$env:USERPROFILE\.cargo\bin\bore.exe"
        Start-Process -NoNewWindow -FilePath $borePath -ArgumentList "local 3389 --to bore.pub"
        Write-Output "RDP tunnel started. Connect using the bore endpoint in logs."
        Write-Output "Username: topuser"
        Write-Output "Password: supersecret"
        Start-Sleep -Seconds $env:rdp_seconds
