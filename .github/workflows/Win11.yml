name: Windows 11 RDP via Bore 

on:
  workflow_dispatch:
    inputs:
      rdp_hours:
        description: 'Number of hours to enable RDP session (1â€“6)'
        required: true
        default: '6'
        type: string
      user:
        description: 'Username requesting the RDP session'
        required: true
        type: string

# Dynamic run name that includes the user
run-name: 'Windows 11 run by ${{ inputs.user }}'

jobs:
  build:
    runs-on: windows-2025
    timeout-minutes: 360
    
    steps:
    - name: Display User Session Info
      run: |
        echo "ğŸ–¥ï¸ Starting RDP Session for User: ${{ inputs.user }}"
        echo "â° Duration: ${{ inputs.rdp_hours }} hours"
        echo "ğŸ“… Started: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        echo "ğŸ†” User ID: ${{ inputs.user }}"
        
    - name: Download Bore
      run: |
        echo "ğŸ“¥ Downloading bore tunnel for user: ${{ inputs.user }}"
        Invoke-WebRequest -Uri "https://github.com/ekzhang/bore/releases/download/v0.4.0/bore-v0.4.0-x86_64-pc-windows-msvc.zip" -OutFile "bore.zip"
        Expand-Archive -Path "bore.zip" -DestinationPath "bore"
        
    - name: Set up RDP
      run: |
        echo "âš™ï¸ Configuring RDP for user: ${{ inputs.user }}"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-TCP' -name "UserAuthentication" -Value 1

    - name: Configure RDP Users
      run: |
        echo "ğŸ‘¥ Setting up RDP users for: ${{ inputs.user }}"
        
        # Change runneradmin password
        net user runneradmin "Ab@1234"
        
        # Create topuser account
        net user topuser "T0pUser#25" /add
        
        # Add both users to Remote Desktop Users group
        net localgroup "Remote Desktop Users" runneradmin /add
        net localgroup "Remote Desktop Users" topuser /add
        
        # Grant logon as service right (optional but recommended)
        net localgroup "Users" topuser /add
        
        echo "âœ… RDP users configured successfully"

    - name: Start RDP Session
      run: |
        $user = "${{ inputs.user }}"
        $hours = [int]"${{ inputs.rdp_hours }}"
        $minutes = $hours * 60
        
        echo "ğŸš€ Starting RDP Session:"
        echo "   User: $user"
        echo "   Duration: $hours hours"
        
        # Start bore tunnel
        echo "ğŸŒ Starting bore tunnel..."
        Start-Process -FilePath "bore\bore.exe" -ArgumentList "local", "3389", "--to", "bore.pub" -NoNewWindow -PassThru
        
        Start-Sleep -Seconds 5
        
        echo "âœ… RDP Session Active for user: $user"
        echo "ğŸ”‘ Login Credentials:"
        echo "   Username: topuser | Password: T0pUser#25"
        echo "   Username: runneradmin | Password: Ab@1234"
        echo ""
        echo "ğŸŒ Connection will be available via bore.pub tunnel"
        echo "ğŸ‘¤ Session Owner: $user"
        echo "ğŸ“… Session Started: $(Get-Date)"
        echo "â° Session Duration: $hours hours"
        
        # Keep session alive
        Start-Sleep -Seconds ($minutes * 60)
